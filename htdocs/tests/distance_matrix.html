<!DOCTYPE html>
<html>
<head>
	<title>Distance Matrix service</title>
	<script type="text/javascript" src="/htdocs/js/MooTools-Core-1.5.2.js"></script>
</head>
<body>
<div id="output"></div>
<script>

	var point = function(x, y){
		return {
			'x':x,
			'y':y
		};
	};

	var Distance = new Class({
		Implements: [Events, Options],
		options: {
			points: []
		},
		points: [],
		gStartPoints: [],
		gEndPoints: [],
		distances: [],
		distance: 0, //m
		durations: [],
		duration: 0, //s
		initialize: function (options) {
			this.setOptions(options);
			this.points = this.options.points;
			if(this.points.length < 2) {
				console.log('Distance should have min 2 points!');
				return false;
			}
			this.gStartPoints.push(new google.maps.LatLng(this.points[0].x, this.points[0].y));
			var last = this.points.length - 1;
			for (var i = 1; i < last; i++) {
				this.gStartPoints.push(new google.maps.LatLng(this.points[i].x, this.points[i].y));
				this.gEndPoints.push(new google.maps.LatLng(this.points[i].x, this.points[i].y));
			}
			this.gEndPoints.push(new google.maps.LatLng(this.points[last].x, this.points[last].y));
			console.log(this.gStartPoints, this.gEndPoints);
		},
		compute: function (callback) {
			var service = new google.maps.DistanceMatrixService();
			service.getDistanceMatrix({
				origins: this.gStartPoints,
				destinations: this.gEndPoints,
				travelMode: google.maps.TravelMode.DRIVING,
				unitSystem: google.maps.UnitSystem.METRIC,
				avoidHighways: false,
				avoidTolls: false
			},this.gResponse.bind(this));
			this.computeCallback = callback;
		},
		gResponse: function(ret, status) {
			if(status != google.maps.DistanceMatrixStatus.OK) {
				console.log('Fail, gStatus was: ' + status);
				// failback ?!? //
				return false;
			}
			console.log(ret);
			var origin = ret.originAddresses;
			var dest = ret.destinationAddresses;
			var rows = ret.rows;

			for(var i = 0; i < origin.length; i++) {
				var results = rows[i].elements;
				//for(var j =0; j < results.length; j++) {
					var j=i;
					this.distances.push(results[j].distance.value);
					this.durations.push(results[j].duration.value);
					this.distance += results[j].distance.value;
					this.duration += results[j].duration.value;
				//}
			}
			if(this.computeCallback) {
				this.computeCallback.call(this,this);
			}
		}
	});

	var distanceCallback = function () {
		var distance = new Distance({
			points:[
				new point(44.5628889, 27.3613656),
				new point(44.4267674, 26.102538399999958),
				new point(45.6579755, 25.601197700000057),
				new point(46.7712101, 23.623635299999933),
			]
		});
		distance.compute(function(ret) {
			console.log(ret.distance/1000);
			console.log(ret.duration/3600);
		});
	};


</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAkPNe2KIDnQDCwOLvCqkDPAVTNmhtxDvE&signed_in=true&callback=distanceCallback"
		async defer></script>
</body>
</html>